<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mechanical keyboard firmware based around the STM32 HAL libraries: /home/alxhoff/git/Embedded/stm32-mech-keyboard/NuceloKeyboardController/Src/scan.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Mechanical keyboard firmware based around the STM32 HAL libraries
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_65157e439c706bbd2af5306bcfdb40bd.html">NuceloKeyboardController</a></li><li class="navelem"><a class="el" href="dir_91ec91170fbffabc815b574deec3a91b.html">Src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">scan.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Functions used to scan the keyboard for input.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="keymap_8h_source.html">keymap.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="keyboard_8h_source.html">keyboard.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="scan_8h_source.html">scan.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="extern_8h_source.html">extern.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="lookup_8h_source.html">lookup.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="types_8h_source.html">types.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="shift_8h_source.html">shift.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ae487492e4ee9e86f27bcc764386842b8"><td class="memItemLeft" align="right" valign="top">int8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scan_8c.html#ae487492e4ee9e86f27bcc764386842b8">scan_key_matrix</a> (<a class="el" href="datatypes_8h.html#ad5787d8aae284c464e53e68876e82918">keyboard_device_t</a> *keyboard_dev, <a class="el" href="datatypes_8h.html#a9539035ff5404f9a5fb4c1985d2f3fcc">keyboard_HID_data_t</a> *HID_reports, <a class="el" href="datatypes_8h.html#adb530ee69b7a28ad91cf00a7c665a2f5">shift_array_t</a> *<a class="el" href="structshift__array.html">shift_array</a>)</td></tr>
<tr class="memdesc:ae487492e4ee9e86f27bcc764386842b8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main scanning function called during normal operation of the keyboard.  <a href="#ae487492e4ee9e86f27bcc764386842b8">More...</a><br /></td></tr>
<tr class="separator:ae487492e4ee9e86f27bcc764386842b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a121a60a92d712e7ffd0e739a83b3c390"><td class="memItemLeft" align="right" valign="top"><a class="el" href="types_8h.html#ab2ec6709cce876f14501785dbb8e89f3">key_code</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scan_8c.html#a121a60a92d712e7ffd0e739a83b3c390">scan_get_single_key</a> (<a class="el" href="datatypes_8h.html#ad5787d8aae284c464e53e68876e82918">keyboard_device_t</a> *keyboard_dev, <a class="el" href="datatypes_8h.html#ac282a7a696b1d7d36df8c0f4ebce07e7">keymap_list_t</a> *layer_list)</td></tr>
<tr class="memdesc:a121a60a92d712e7ffd0e739a83b3c390"><td class="mdescLeft">&#160;</td><td class="mdescRight">Gets a single not debounced key input from the keyboad.  <a href="#a121a60a92d712e7ffd0e739a83b3c390">More...</a><br /></td></tr>
<tr class="separator:a121a60a92d712e7ffd0e739a83b3c390"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afb42a950d8c0ac59638b28d024d3a285"><td class="memItemLeft" align="right" valign="top"><a class="el" href="types_8h.html#a089d78d0d2dff7b379245e1f9f46b510">key_code_w_mod_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scan_8c.html#afb42a950d8c0ac59638b28d024d3a285">scan_get_single_key_w_mod</a> (<a class="el" href="datatypes_8h.html#ad5787d8aae284c464e53e68876e82918">keyboard_device_t</a> *keyboard_dev, <a class="el" href="datatypes_8h.html#ac282a7a696b1d7d36df8c0f4ebce07e7">keymap_list_t</a> *layer_list)</td></tr>
<tr class="memdesc:afb42a950d8c0ac59638b28d024d3a285"><td class="mdescLeft">&#160;</td><td class="mdescRight">Gets a single not debounced key input from the keyboad with a key modifier.  <a href="#afb42a950d8c0ac59638b28d024d3a285">More...</a><br /></td></tr>
<tr class="separator:afb42a950d8c0ac59638b28d024d3a285"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8ccf32f8d94b5c327ab70444df07db75"><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scan_8c.html#a8ccf32f8d94b5c327ab70444df07db75">scan_get_single_key_char</a> (<a class="el" href="datatypes_8h.html#ad5787d8aae284c464e53e68876e82918">keyboard_device_t</a> *keyboard_dev, <a class="el" href="datatypes_8h.html#ac282a7a696b1d7d36df8c0f4ebce07e7">keymap_list_t</a> *layer_list)</td></tr>
<tr class="memdesc:a8ccf32f8d94b5c327ab70444df07db75"><td class="mdescLeft">&#160;</td><td class="mdescRight">Gets single character input from the keyboard.  <a href="#a8ccf32f8d94b5c327ab70444df07db75">More...</a><br /></td></tr>
<tr class="separator:a8ccf32f8d94b5c327ab70444df07db75"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8ab546930f300c56a9c074d289f5ad6d"><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scan_8c.html#a8ab546930f300c56a9c074d289f5ad6d">scan_get_input_seq</a> (<a class="el" href="datatypes_8h.html#ad5787d8aae284c464e53e68876e82918">keyboard_device_t</a> *keyboard_dev, <a class="el" href="datatypes_8h.html#ac282a7a696b1d7d36df8c0f4ebce07e7">keymap_list_t</a> *layer_list, char exit_char)</td></tr>
<tr class="memdesc:a8ab546930f300c56a9c074d289f5ad6d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Gets input sequence from keyboard.  <a href="#a8ab546930f300c56a9c074d289f5ad6d">More...</a><br /></td></tr>
<tr class="separator:a8ab546930f300c56a9c074d289f5ad6d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Functions used to scan the keyboard for input. </p>
<dl class="section author"><dt>Author</dt><dd>Alex Hoffman </dd></dl>
<dl class="section date"><dt>Date</dt><dd>11 October 2017 </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a8ab546930f300c56a9c074d289f5ad6d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8ab546930f300c56a9c074d289f5ad6d">&#9670;&nbsp;</a></span>scan_get_input_seq()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* scan_get_input_seq </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#ad5787d8aae284c464e53e68876e82918">keyboard_device_t</a> *&#160;</td>
          <td class="paramname"><em>keyboard_dev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#ac282a7a696b1d7d36df8c0f4ebce07e7">keymap_list_t</a> *&#160;</td>
          <td class="paramname"><em>layer_list</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&#160;</td>
          <td class="paramname"><em>exit_char</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Gets input sequence from keyboard. </p>
<p>Reads in input from the keyboard until a certain key is pressed</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">keyboard_dev</td><td>Keyboard device that is to be scanned </td></tr>
    <tr><td class="paramname">layer_list</td><td>Layer list to be used to find the key's key code </td></tr>
    <tr><td class="paramname">exit_char</td><td>Character to be presed to exit the function </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Char pointer to a string representation of the input </dd></dl>

</div>
</div>
<a id="a121a60a92d712e7ffd0e739a83b3c390"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a121a60a92d712e7ffd0e739a83b3c390">&#9670;&nbsp;</a></span>scan_get_single_key()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="types_8h.html#ab2ec6709cce876f14501785dbb8e89f3">key_code</a> scan_get_single_key </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#ad5787d8aae284c464e53e68876e82918">keyboard_device_t</a> *&#160;</td>
          <td class="paramname"><em>keyboard_dev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#ac282a7a696b1d7d36df8c0f4ebce07e7">keymap_list_t</a> *&#160;</td>
          <td class="paramname"><em>layer_list</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Gets a single not debounced key input from the keyboad. </p>
<p>Works in a similar fashion to scan_key_matrix but but the function returns upon finding a pressed key. Retrieves a single key and does not prioritise keys in any way. First found is the one returned. <br />
 Also retrieves the key code for the key from the bottom most keyboard layer</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">keyboard_dev</td><td>Keyboard device that is to be scanned </td></tr>
    <tr><td class="paramname">layer_list</td><td>Layer list to be used to find the key's key code </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The key code of a single key press from the bottom most layer of the keyboard layer </dd></dl>

</div>
</div>
<a id="a8ccf32f8d94b5c327ab70444df07db75"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8ccf32f8d94b5c327ab70444df07db75">&#9670;&nbsp;</a></span>scan_get_single_key_char()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* scan_get_single_key_char </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#ad5787d8aae284c464e53e68876e82918">keyboard_device_t</a> *&#160;</td>
          <td class="paramname"><em>keyboard_dev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#ac282a7a696b1d7d36df8c0f4ebce07e7">keymap_list_t</a> *&#160;</td>
          <td class="paramname"><em>layer_list</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Gets single character input from the keyboard. </p>
<p>The keyboard is scanned and a single character input is found</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">keyboard_dev</td><td>Keyboard device that is to be scanned </td></tr>
    <tr><td class="paramname">layer_list</td><td>Layer list to be used to find the key's key code </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Single char from keyboard input </dd></dl>

</div>
</div>
<a id="afb42a950d8c0ac59638b28d024d3a285"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afb42a950d8c0ac59638b28d024d3a285">&#9670;&nbsp;</a></span>scan_get_single_key_w_mod()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="types_8h.html#a089d78d0d2dff7b379245e1f9f46b510">key_code_w_mod_t</a> scan_get_single_key_w_mod </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#ad5787d8aae284c464e53e68876e82918">keyboard_device_t</a> *&#160;</td>
          <td class="paramname"><em>keyboard_dev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#ac282a7a696b1d7d36df8c0f4ebce07e7">keymap_list_t</a> *&#160;</td>
          <td class="paramname"><em>layer_list</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Gets a single not debounced key input from the keyboad with a key modifier. </p>
<p>Works in a similar fashion to scan_key_matrix but but the function returns upon finding a pressed key. Retrieves a single key and key modifier. Does not prioritise keys in any way. First found is the one returned. <br />
 Also retrieves the key code for the key from the bottom most keyboard layer</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">keyboard_dev</td><td>Keyboard device that is to be scanned </td></tr>
    <tr><td class="paramname">layer_list</td><td>Layer list to be used to find the key's key code </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The key code/key modifier pair of a single key press from the bottom most layer of the keyboard </dd></dl>

</div>
</div>
<a id="ae487492e4ee9e86f27bcc764386842b8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae487492e4ee9e86f27bcc764386842b8">&#9670;&nbsp;</a></span>scan_key_matrix()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int8_t scan_key_matrix </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#ad5787d8aae284c464e53e68876e82918">keyboard_device_t</a> *&#160;</td>
          <td class="paramname"><em>keyboard_dev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#a9539035ff5404f9a5fb4c1985d2f3fcc">keyboard_HID_data_t</a> *&#160;</td>
          <td class="paramname"><em>HID_reports</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="datatypes_8h.html#adb530ee69b7a28ad91cf00a7c665a2f5">shift_array_t</a> *&#160;</td>
          <td class="paramname"><em>shift_array</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main scanning function called during normal operation of the keyboard. </p>
<p>During normal operation of the keyboard (acting as a HID device to the PC) the keyboard must be scanned many times each second to detect key press events. This scanning is done by setting the column pins high and polling the row pins to see if a key, at co-ordinates(column,row), has been pressed. To minimize the number of required GPIO pins a shift register is used to set the column pins. The scann process is as follows: <br />
 - Keypress buffer is cleared <br />
</p><ul>
<li>The fist column GPIO is set hight <br />
</li>
<li>Each row GPIO is then polled to detech key press events <br />
</li>
<li>Key press events are stored into the key buffer, incrementing the key buffer count <br />
</li>
<li>Once each row has been polled the column is set low again and the next column is set high. This is done until all columns have been tested.</li>
</ul>
<p>There is no debouncing in this function as the reports are naturally debounced through the USB HID report delay.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">keyboard_dev</td><td>Keyboard device that is to be scanned </td></tr>
    <tr><td class="paramname">HID_reports</td><td>HID data structure where the key buffer is to be stored </td></tr>
    <tr><td class="paramname"><a class="el" href="structshift__array.html">shift_array</a></td><td>Shift array that is to be used to set the columns high </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success </dd></dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
