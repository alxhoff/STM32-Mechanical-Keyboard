\hypertarget{scan_8c}{}\section{/home/alxhoff/git/\+Embedded/stm32-\/mech-\/keyboard/\+Nucelo\+Keyboard\+Controller/\+Src/scan.c File Reference}
\label{scan_8c}\index{/home/alxhoff/git/\+Embedded/stm32-\/mech-\/keyboard/\+Nucelo\+Keyboard\+Controller/\+Src/scan.\+c@{/home/alxhoff/git/\+Embedded/stm32-\/mech-\/keyboard/\+Nucelo\+Keyboard\+Controller/\+Src/scan.\+c}}


Functions used to scan the keyboard for input.  


{\ttfamily \#include \char`\"{}keymap.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}keyboard.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}scan.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}extern.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}lookup.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}types.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}shift.\+h\char`\"{}}\newline
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int8\+\_\+t \hyperlink{scan_8c_ae487492e4ee9e86f27bcc764386842b8}{scan\+\_\+key\+\_\+matrix} (\hyperlink{datatypes_8h_ad5787d8aae284c464e53e68876e82918}{keyboard\+\_\+device\+\_\+t} $\ast$keyboard\+\_\+dev, \hyperlink{datatypes_8h_a9539035ff5404f9a5fb4c1985d2f3fcc}{keyboard\+\_\+\+H\+I\+D\+\_\+data\+\_\+t} $\ast$H\+I\+D\+\_\+reports, \hyperlink{datatypes_8h_adb530ee69b7a28ad91cf00a7c665a2f5}{shift\+\_\+array\+\_\+t} $\ast$\hyperlink{structshift__array}{shift\+\_\+array})
\begin{DoxyCompactList}\small\item\em Main scanning function called during normal operation of the keyboard. \end{DoxyCompactList}\item 
\hyperlink{types_8h_ab2ec6709cce876f14501785dbb8e89f3}{key\+\_\+code} \hyperlink{scan_8c_a121a60a92d712e7ffd0e739a83b3c390}{scan\+\_\+get\+\_\+single\+\_\+key} (\hyperlink{datatypes_8h_ad5787d8aae284c464e53e68876e82918}{keyboard\+\_\+device\+\_\+t} $\ast$keyboard\+\_\+dev, \hyperlink{datatypes_8h_ac282a7a696b1d7d36df8c0f4ebce07e7}{keymap\+\_\+list\+\_\+t} $\ast$layer\+\_\+list)
\begin{DoxyCompactList}\small\item\em Gets a single not debounced key input from the keyboad. \end{DoxyCompactList}\item 
\hyperlink{types_8h_a089d78d0d2dff7b379245e1f9f46b510}{key\+\_\+code\+\_\+w\+\_\+mod\+\_\+t} \hyperlink{scan_8c_afb42a950d8c0ac59638b28d024d3a285}{scan\+\_\+get\+\_\+single\+\_\+key\+\_\+w\+\_\+mod} (\hyperlink{datatypes_8h_ad5787d8aae284c464e53e68876e82918}{keyboard\+\_\+device\+\_\+t} $\ast$keyboard\+\_\+dev, \hyperlink{datatypes_8h_ac282a7a696b1d7d36df8c0f4ebce07e7}{keymap\+\_\+list\+\_\+t} $\ast$layer\+\_\+list)
\begin{DoxyCompactList}\small\item\em Gets a single not debounced key input from the keyboad with a key modifier. \end{DoxyCompactList}\item 
char $\ast$ \hyperlink{scan_8c_a8ccf32f8d94b5c327ab70444df07db75}{scan\+\_\+get\+\_\+single\+\_\+key\+\_\+char} (\hyperlink{datatypes_8h_ad5787d8aae284c464e53e68876e82918}{keyboard\+\_\+device\+\_\+t} $\ast$keyboard\+\_\+dev, \hyperlink{datatypes_8h_ac282a7a696b1d7d36df8c0f4ebce07e7}{keymap\+\_\+list\+\_\+t} $\ast$layer\+\_\+list)
\begin{DoxyCompactList}\small\item\em Gets single character input from the keyboard. \end{DoxyCompactList}\item 
char $\ast$ \hyperlink{scan_8c_a8ab546930f300c56a9c074d289f5ad6d}{scan\+\_\+get\+\_\+input\+\_\+seq} (\hyperlink{datatypes_8h_ad5787d8aae284c464e53e68876e82918}{keyboard\+\_\+device\+\_\+t} $\ast$keyboard\+\_\+dev, \hyperlink{datatypes_8h_ac282a7a696b1d7d36df8c0f4ebce07e7}{keymap\+\_\+list\+\_\+t} $\ast$layer\+\_\+list, char exit\+\_\+char)
\begin{DoxyCompactList}\small\item\em Gets input sequence from keyboard. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Functions used to scan the keyboard for input. 

\begin{DoxyAuthor}{Author}
Alex Hoffman 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
11 October 2017 
\end{DoxyDate}


\subsection{Function Documentation}
\mbox{\Hypertarget{scan_8c_a8ab546930f300c56a9c074d289f5ad6d}\label{scan_8c_a8ab546930f300c56a9c074d289f5ad6d}} 
\index{scan.\+c@{scan.\+c}!scan\+\_\+get\+\_\+input\+\_\+seq@{scan\+\_\+get\+\_\+input\+\_\+seq}}
\index{scan\+\_\+get\+\_\+input\+\_\+seq@{scan\+\_\+get\+\_\+input\+\_\+seq}!scan.\+c@{scan.\+c}}
\subsubsection{\texorpdfstring{scan\+\_\+get\+\_\+input\+\_\+seq()}{scan\_get\_input\_seq()}}
{\footnotesize\ttfamily char$\ast$ scan\+\_\+get\+\_\+input\+\_\+seq (\begin{DoxyParamCaption}\item[{\hyperlink{datatypes_8h_ad5787d8aae284c464e53e68876e82918}{keyboard\+\_\+device\+\_\+t} $\ast$}]{keyboard\+\_\+dev,  }\item[{\hyperlink{datatypes_8h_ac282a7a696b1d7d36df8c0f4ebce07e7}{keymap\+\_\+list\+\_\+t} $\ast$}]{layer\+\_\+list,  }\item[{char}]{exit\+\_\+char }\end{DoxyParamCaption})}



Gets input sequence from keyboard. 

Reads in input from the keyboard until a certain key is pressed


\begin{DoxyParams}{Parameters}
{\em keyboard\+\_\+dev} & Keyboard device that is to be scanned \\
\hline
{\em layer\+\_\+list} & Layer list to be used to find the key\textquotesingle{}s key code \\
\hline
{\em exit\+\_\+char} & Character to be presed to exit the function \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Char pointer to a string representation of the input 
\end{DoxyReturn}
\mbox{\Hypertarget{scan_8c_a121a60a92d712e7ffd0e739a83b3c390}\label{scan_8c_a121a60a92d712e7ffd0e739a83b3c390}} 
\index{scan.\+c@{scan.\+c}!scan\+\_\+get\+\_\+single\+\_\+key@{scan\+\_\+get\+\_\+single\+\_\+key}}
\index{scan\+\_\+get\+\_\+single\+\_\+key@{scan\+\_\+get\+\_\+single\+\_\+key}!scan.\+c@{scan.\+c}}
\subsubsection{\texorpdfstring{scan\+\_\+get\+\_\+single\+\_\+key()}{scan\_get\_single\_key()}}
{\footnotesize\ttfamily \hyperlink{types_8h_ab2ec6709cce876f14501785dbb8e89f3}{key\+\_\+code} scan\+\_\+get\+\_\+single\+\_\+key (\begin{DoxyParamCaption}\item[{\hyperlink{datatypes_8h_ad5787d8aae284c464e53e68876e82918}{keyboard\+\_\+device\+\_\+t} $\ast$}]{keyboard\+\_\+dev,  }\item[{\hyperlink{datatypes_8h_ac282a7a696b1d7d36df8c0f4ebce07e7}{keymap\+\_\+list\+\_\+t} $\ast$}]{layer\+\_\+list }\end{DoxyParamCaption})}



Gets a single not debounced key input from the keyboad. 

Works in a similar fashion to scan\+\_\+key\+\_\+matrix but but the function returns upon finding a pressed key. Retrieves a single key and does not prioritise keys in any way. First found is the one returned. ~\newline
 Also retrieves the key code for the key from the bottom most keyboard layer


\begin{DoxyParams}{Parameters}
{\em keyboard\+\_\+dev} & Keyboard device that is to be scanned \\
\hline
{\em layer\+\_\+list} & Layer list to be used to find the key\textquotesingle{}s key code \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The key code of a single key press from the bottom most layer of the keyboard layer 
\end{DoxyReturn}
\mbox{\Hypertarget{scan_8c_a8ccf32f8d94b5c327ab70444df07db75}\label{scan_8c_a8ccf32f8d94b5c327ab70444df07db75}} 
\index{scan.\+c@{scan.\+c}!scan\+\_\+get\+\_\+single\+\_\+key\+\_\+char@{scan\+\_\+get\+\_\+single\+\_\+key\+\_\+char}}
\index{scan\+\_\+get\+\_\+single\+\_\+key\+\_\+char@{scan\+\_\+get\+\_\+single\+\_\+key\+\_\+char}!scan.\+c@{scan.\+c}}
\subsubsection{\texorpdfstring{scan\+\_\+get\+\_\+single\+\_\+key\+\_\+char()}{scan\_get\_single\_key\_char()}}
{\footnotesize\ttfamily char$\ast$ scan\+\_\+get\+\_\+single\+\_\+key\+\_\+char (\begin{DoxyParamCaption}\item[{\hyperlink{datatypes_8h_ad5787d8aae284c464e53e68876e82918}{keyboard\+\_\+device\+\_\+t} $\ast$}]{keyboard\+\_\+dev,  }\item[{\hyperlink{datatypes_8h_ac282a7a696b1d7d36df8c0f4ebce07e7}{keymap\+\_\+list\+\_\+t} $\ast$}]{layer\+\_\+list }\end{DoxyParamCaption})}



Gets single character input from the keyboard. 

The keyboard is scanned and a single character input is found


\begin{DoxyParams}{Parameters}
{\em keyboard\+\_\+dev} & Keyboard device that is to be scanned \\
\hline
{\em layer\+\_\+list} & Layer list to be used to find the key\textquotesingle{}s key code \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Single char from keyboard input 
\end{DoxyReturn}
\mbox{\Hypertarget{scan_8c_afb42a950d8c0ac59638b28d024d3a285}\label{scan_8c_afb42a950d8c0ac59638b28d024d3a285}} 
\index{scan.\+c@{scan.\+c}!scan\+\_\+get\+\_\+single\+\_\+key\+\_\+w\+\_\+mod@{scan\+\_\+get\+\_\+single\+\_\+key\+\_\+w\+\_\+mod}}
\index{scan\+\_\+get\+\_\+single\+\_\+key\+\_\+w\+\_\+mod@{scan\+\_\+get\+\_\+single\+\_\+key\+\_\+w\+\_\+mod}!scan.\+c@{scan.\+c}}
\subsubsection{\texorpdfstring{scan\+\_\+get\+\_\+single\+\_\+key\+\_\+w\+\_\+mod()}{scan\_get\_single\_key\_w\_mod()}}
{\footnotesize\ttfamily \hyperlink{types_8h_a089d78d0d2dff7b379245e1f9f46b510}{key\+\_\+code\+\_\+w\+\_\+mod\+\_\+t} scan\+\_\+get\+\_\+single\+\_\+key\+\_\+w\+\_\+mod (\begin{DoxyParamCaption}\item[{\hyperlink{datatypes_8h_ad5787d8aae284c464e53e68876e82918}{keyboard\+\_\+device\+\_\+t} $\ast$}]{keyboard\+\_\+dev,  }\item[{\hyperlink{datatypes_8h_ac282a7a696b1d7d36df8c0f4ebce07e7}{keymap\+\_\+list\+\_\+t} $\ast$}]{layer\+\_\+list }\end{DoxyParamCaption})}



Gets a single not debounced key input from the keyboad with a key modifier. 

Works in a similar fashion to scan\+\_\+key\+\_\+matrix but but the function returns upon finding a pressed key. Retrieves a single key and key modifier. Does not prioritise keys in any way. First found is the one returned. ~\newline
 Also retrieves the key code for the key from the bottom most keyboard layer


\begin{DoxyParams}{Parameters}
{\em keyboard\+\_\+dev} & Keyboard device that is to be scanned \\
\hline
{\em layer\+\_\+list} & Layer list to be used to find the key\textquotesingle{}s key code \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The key code/key modifier pair of a single key press from the bottom most layer of the keyboard 
\end{DoxyReturn}
\mbox{\Hypertarget{scan_8c_ae487492e4ee9e86f27bcc764386842b8}\label{scan_8c_ae487492e4ee9e86f27bcc764386842b8}} 
\index{scan.\+c@{scan.\+c}!scan\+\_\+key\+\_\+matrix@{scan\+\_\+key\+\_\+matrix}}
\index{scan\+\_\+key\+\_\+matrix@{scan\+\_\+key\+\_\+matrix}!scan.\+c@{scan.\+c}}
\subsubsection{\texorpdfstring{scan\+\_\+key\+\_\+matrix()}{scan\_key\_matrix()}}
{\footnotesize\ttfamily int8\+\_\+t scan\+\_\+key\+\_\+matrix (\begin{DoxyParamCaption}\item[{\hyperlink{datatypes_8h_ad5787d8aae284c464e53e68876e82918}{keyboard\+\_\+device\+\_\+t} $\ast$}]{keyboard\+\_\+dev,  }\item[{\hyperlink{datatypes_8h_a9539035ff5404f9a5fb4c1985d2f3fcc}{keyboard\+\_\+\+H\+I\+D\+\_\+data\+\_\+t} $\ast$}]{H\+I\+D\+\_\+reports,  }\item[{\hyperlink{datatypes_8h_adb530ee69b7a28ad91cf00a7c665a2f5}{shift\+\_\+array\+\_\+t} $\ast$}]{shift\+\_\+array }\end{DoxyParamCaption})}



Main scanning function called during normal operation of the keyboard. 

During normal operation of the keyboard (acting as a H\+ID device to the PC) the keyboard must be scanned many times each second to detect key press events. This scanning is done by setting the column pins high and polling the row pins to see if a key, at co-\/ordinates(column,row), has been pressed. To minimize the number of required G\+P\+IO pins a shift register is used to set the column pins. The scann process is as follows\+: ~\newline
 -\/ Keypress buffer is cleared ~\newline

\begin{DoxyItemize}
\item The fist column G\+P\+IO is set hight ~\newline

\item Each row G\+P\+IO is then polled to detech key press events ~\newline

\item Key press events are stored into the key buffer, incrementing the key buffer count ~\newline

\item Once each row has been polled the column is set low again and the next column is set high. This is done until all columns have been tested.
\end{DoxyItemize}

There is no debouncing in this function as the reports are naturally debounced through the U\+SB H\+ID report delay.


\begin{DoxyParams}{Parameters}
{\em keyboard\+\_\+dev} & Keyboard device that is to be scanned \\
\hline
{\em H\+I\+D\+\_\+reports} & H\+ID data structure where the key buffer is to be stored \\
\hline
{\em \hyperlink{structshift__array}{shift\+\_\+array}} & Shift array that is to be used to set the columns high \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
0 on success 
\end{DoxyReturn}
